<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="meta.title">AutoVid Generator — Test Workflow</title>
  <meta name="description" data-i18n-attr="content|meta.desc" content="Trigger the workflow and preview the processed video on YouTube." />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- ─── Security headers as <meta> (mejor como headers del server; aquí en meta para GitHub Pages) ─── -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https: data:;
    frame-src https://www.youtube.com;
    connect-src 'self';
    base-uri 'self';
    form-action 'none';
    object-src 'none';
    frame-ancestors 'self';
    upgrade-insecure-requests;
  ">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">

  <style>
    :root{
      --bg:#080a0f; --bg2:#0d1220; --fg:#eaf1fa; --muted:#a1b1c6; --card:#121826; --border:#1e2a3a;
      --acc:#7c5cff; --acc2:#1ea0ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --input:#0e1522;
      --chip:#0e1a2a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,sans-serif; color:var(--fg);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.15), transparent 60%),
                  radial-gradient(1200px 600px at 110% 10%, rgba(30,160,255,.12), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100dvh;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:64px 24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;position:relative}
    .brand{font-weight:800;font-size:28px;letter-spacing:.4px;background:linear-gradient(90deg,var(--acc),var(--acc2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .brand-sub{font-size:14px;color:var(--muted);margin-top:4px}
    .lang-switch{
      position:absolute;top:-36px;right:0;display:inline-flex;gap:10px;align-items:center;
      border:1px solid var(--border);background:#0a0f18;border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px
    }
    .lang-switch button{
      display:inline-flex;align-items:center;gap:6px;background:transparent;color:var(--fg);
      border:0;cursor:pointer;padding:4px 8px;border-radius:999px;font-weight:700
    }
    .lang-switch button[aria-current="true"]{background:linear-gradient(90deg,var(--acc),var(--acc2));color:#fff}
    .flag{width:16px;height:12px;border-radius:2px;overflow:hidden;display:inline-block}
    .flag svg{display:block;width:16px;height:12px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:24px;padding:32px 28px;
      box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .card + .card{margin-top:16px}
    h1{margin:0 0 6px;font-size:30px;font-weight:800}
    p{color:var(--muted);line-height:1.7;font-size:16px}

    .notice{
      display:flex;gap:12px;align-items:flex-start;background:rgba(245,158,11,.08);
      border:1px solid rgba(245,158,11,.35);border-radius:14px;padding:12px 14px;margin-top:14px
    }
    .notice strong{color:#ffd27a}
    .notice svg{min-width:20px}

    .form{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:16px}
    .input{
      flex:1 1 280px;min-width:220px;background:var(--input);color:var(--fg);border:1px solid var(--border);
      border-radius:12px;padding:12px 14px;font-size:15px;outline:none;transition:border .2s ease, box-shadow .2s ease
    }
    .input::placeholder{color:#7d8a9e}
    .input:focus{border-color:#2a3948;box-shadow:0 0 0 3px rgba(124,92,255,.18)}

    .btn{
      background:linear-gradient(90deg,var(--acc),var(--acc2));color:#fff;border:0;border-radius:14px;
      padding:12px 18px;font-weight:700;font-size:15px;cursor:pointer;white-space:nowrap;
      box-shadow:0 10px 24px rgba(0,0,0,.35);transition:transform .18s ease, filter .18s ease
    }
    .btn:hover{transform:translateY(-1px) scale(1.02);filter:brightness(1.03)}
    .btn:active{transform:translateY(0);filter:brightness(.98)}
    .btn.secondary{
      background:#0f1a2a;border:1px solid var(--border);color:#cfe0ff
    }

    .loading{display:none;color:#c9d7e6;font-style:italic;margin-top:14px}
    .embed{display:none;margin-top:18px;background:#0d1424;border:1px solid var(--border);border-radius:16px;padding:16px}
    iframe{width:100%;aspect-ratio:16 / 9;border:0;border-radius:12px}
    .yt-actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .yt-actions a{color:#a7c7ff;text-decoration:none;font-weight:600}
    .yt-actions a:hover{text-decoration:underline}

    footer{margin-top:32px;color:#7f8ea3;font-size:13px;text-align:center}
    @media (max-width:520px){
      .wrap{padding:32px 16px}
      .card{padding:24px}
      h1{font-size:26px}
      .lang-switch{top:-44px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">AutoVid Generator</div>
        <div class="brand-sub" data-i18n="brand.by">By Vision Arcadia</div>
      </div>

      <!-- EN | ES -->
      <nav class="lang-switch" aria-label="Language switch">
        <button id="btn-en" type="button" aria-current="true" data-lang="en" title="English">
          <span class="flag" aria-hidden="true">
            <!-- EN flag -->
            <svg viewBox="0 0 16 12"><rect width="16" height="12" fill="#b22234"/><g fill="#fff"><rect y="1" width="16" height="1"/><rect y="3" width="16" height="1"/><rect y="5" width="16" height="1"/><rect y="7" width="16" height="1"/><rect y="9" width="16" height="1"/><rect y="11" width="16" height="1"/></g><rect width="7" height="5" fill="#3c3b6e"/></svg>
          </span> EN
        </button>
        <span aria-hidden="true">|</span>
        <button id="btn-es" type="button" data-lang="es" title="Español">
          <span class="flag" aria-hidden="true">
            <!-- ES flag -->
            <svg viewBox="0 0 16 12"><rect width="16" height="12" fill="#aa151b"/><rect y="3" width="16" height="6" fill="#f1bf00"/></svg>
          </span> ES
        </button>
      </nav>
    </header>

    <main class="card">
      <h1 data-i18n="title">Workflow testing</h1>
      <p data-i18n="subtitle">
        Enter a term and press <strong>“Test Workflow”</strong>. When the workflow completes, the YouTube video will appear below.
      </p>

      <div class="notice" role="status" aria-live="polite">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" aria-hidden="true">
          <path d="M12 2l9 18H3L12 2z" stroke="#f3c969" stroke-width="1.5"/><circle cx="12" cy="17" r="1" fill="#f3c969"/>
          <path d="M12 9v5" stroke="#f3c969" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <p data-i18n="warning">
          <strong>Warning:</strong> This service is under active development. This site is intended for testing purposes. Unauthorized users are not allowed to run tests at this time.
        </p>
      </div>

      <div class="form">
        <input type="text" id="term-input" class="input" placeholder="Type a word (e.g., dog)" data-i18n-attr="placeholder|placeholder.term" />
        <button id="test-workflow" class="btn" data-i18n="cta.test">Test Workflow</button>
      </div>

      <div class="loading" id="loading" data-i18n="loading">Generating your video…</div>

      <div class="embed" id="embed">
        <iframe id="yt-embed" allowfullscreen title="YouTube preview"></iframe>
        <div class="yt-actions">
          <a id="yt-link" href="" target="_blank" rel="noopener" data-i18n="open.youtube">Open on YouTube</a>
          <button id="retry-video" class="btn secondary" data-i18n="cta.retry">Retry video</button>
        </div>
      </div>

      <p style="margin-top:12px;color:#8ea0b8">V1.4 (proxy + CSP)</p>
    </main>

    <footer>
      <div><a href="mailto:info@vision-arcadia.store" style="color:#7f8ea3;text-decoration:none;">info@vision-arcadia.store</a></div>
    </footer>
  </div>

  <script>
    // ================== i18n ==================
    const I18N = {
      en:{
        "meta.title":"AutoVid Generator — Test Workflow",
        "meta.desc":"Trigger the workflow and preview the processed video on YouTube.",
        "brand.by":"By Vision Arcadia",
        "title":"Workflow testing",
        "subtitle":"Enter a term and press <strong>“Test Workflow”</strong>. When the workflow completes, the YouTube video will appear below.",
        "warning":"<strong>Notice:</strong> This service is under active development. This site is intended for testing purposes and unauthorized users are not allowed to run tests at this time.",
        "placeholder.term":"Type a word (e.g., dog, engineering, boxing, snow, etc......)",
        "cta.test":"Test Workflow",
        "cta.retry":"Retry video",
        "loading":"Generating your video…",
        "open.youtube":"Open on YouTube"
      },
      es:{
        "meta.title":"AutoVid Generator — Testeo de workflow",
        "meta.desc":"Dispara el workflow y previsualiza el video procesado en YouTube.",
        "brand.by":"Por Vision Arcadia",
        "title":"Testeo de workflow",
        "subtitle":"Escribe un término y presiona <strong>“Test Workflow”</strong>. Cuando el workflow termine, el video de YouTube aparecerá abajo.",
        "warning":"<strong>Aviso:</strong> Este servicio se encuentra en etapa de desarrollo. Este sitio es para testeo y los usuarios no autorizados no pueden realizar pruebas por el momento.",
        "placeholder.term":"Escribe una palabra (ej.: tigre, ingenieria, boxeo, nieve, etc.....)",
        "cta.test":"Test Workflow",
        "cta.retry":"Reintentar video",
        "loading":"Generando tu video…",
        "open.youtube":"Abrir en YouTube"
      }
    };

    function applyI18n(lang){
      const dict = I18N[lang] || I18N.en;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n'); if(!k) return;
        const v = dict[k]; if(v!=null) el.innerHTML = v;
      });
      document.querySelectorAll('[data-i18n-attr]').forEach(el=>{
        const [attr,key] = el.getAttribute('data-i18n-attr').split('|');
        const v = dict[key]; if(attr && v!=null) el.setAttribute(attr, v);
      });
      document.documentElement.setAttribute('lang', lang);
      document.querySelectorAll('.lang-switch button').forEach(btn=>{
        btn.setAttribute('aria-current', btn.dataset.lang===lang ? 'true':'false');
      });
      try{ localStorage.setItem('site_lang', lang); }catch(_){}
    }

    document.getElementById('btn-en').addEventListener('click', ()=>applyI18n('en'));
    document.getElementById('btn-es').addEventListener('click', ()=>applyI18n('es'));

    (function initLang(){
      let qs = null;
      try {
        const p = new URLSearchParams(location.search);
        const q = (p.get('lang') || '').toLowerCase();
        if (q === 'en' || q === 'es') qs = q;
      } catch(_) {}

      let stored = null;
      try { stored = localStorage.getItem('site_lang'); } catch(_) {}

      let auto = 'en';
      try {
        const nav = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
        auto = nav.startsWith('es') ? 'es' : 'en';
      } catch(_) {}

      const lang = qs || (stored === 'en' || stored === 'es' ? stored : null) || auto;
      applyI18n(lang);
    })();

    // ================== App logic (via proxy) ==================
    // Endpoint de tu Cloudflare Worker ruteado bajo tu dominio
    const API_PROXY = '/api/fire';

    // Sanitización/recorte ligero en cliente (la validación real también está en el Worker)
    function sanitizeTerm(raw){
      let t = (raw || '').toString().trim().slice(0,80);
      // letras/números/espacios y ,.-_
      t = t.replace(/[^\p{L}\p{N}\s,\.\-_]/gu, '');
      return t;
    }

    async function fireWorkflow(term, mode='test'){ // mode: 'test' | 'prod'
      const resp = await fetch(API_PROXY, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ term, mode })
      });
      if(!resp.ok){
        const txt = await resp.text();
        throw new Error(`HTTP ${resp.status} — ${txt}`);
      }
      return resp.json();
    }

    function getYoutubeId(url){
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')) return u.pathname.split('/').filter(Boolean).pop();
        if(u.searchParams.has('v')) return u.searchParams.get('v');
        return url.split('/').filter(Boolean).pop(); // shorts/fallback
      }catch{
        return url.split('/').filter(Boolean).pop();
      }
    }

    const $ = (sel)=>document.querySelector(sel);
    const loadingEl = $('#loading');
    const embedEl   = $('#embed');
    const ytEmbed   = $('#yt-embed');
    const ytLink    = $('#yt-link');
    const retryBtn  = $('#retry-video');

    let lastVideoId = null;
    let lastYtUrl   = null;

    // Trigger workflow
    document.getElementById('test-workflow').addEventListener('click', async ()=>{
      const termRaw = document.getElementById('term-input').value;
      const term = sanitizeTerm(termRaw);
      if(!term){
        const m = (document.documentElement.lang==='es')
          ? 'Escribe una palabra primero.' : 'Please type a word first.';
        alert(m);
        return;
      }
      loadingEl.style.display='block';
      embedEl.style.display='none';
      ytEmbed.removeAttribute('src');
      lastVideoId = null; lastYtUrl = null;

      try{
        // Cambia a 'prod' si quieres forzar el flujo de producción
        const data = await fireWorkflow(term, 'test');

        const ytUrl = data.link_yt;
        if(!ytUrl) throw new Error('Missing YouTube URL in response');

        lastYtUrl = ytUrl;
        lastVideoId = getYoutubeId(ytUrl);

        // Pequeño delay extra (si YouTube tarda en habilitar el embed)
        setTimeout(()=>{
          ytEmbed.src = `https://www.youtube.com/embed/${lastVideoId}?rel=0&autoplay=1&cb=${Date.now()}`;
          ytLink.href = ytUrl;
          loadingEl.style.display='none';
          embedEl.style.display='block';
        }, 4000);
      }catch(e){
        console.error(e);
        const m = (document.documentElement.lang==='es')
          ? 'Hubo un error al generar el video: '
          : 'There was an error generating the video: ';
        alert(m + (e?.message||e));
        loadingEl.style.display='none';
      }
    });

    // Retry video: vuelve a montar el mismo embed, con cache-buster y opción de espera
    retryBtn.addEventListener('click', ()=>{
      if(!lastVideoId && lastYtUrl){
        lastVideoId = getYoutubeId(lastYtUrl);
      }
      if(!lastVideoId){
        const m = (document.documentElement.lang==='es')
          ? 'Aún no hay video para reintentar.'
          : 'There is no video to retry yet.';
        alert(m);
        return;
      }
      ytEmbed.src = `https://www.youtube.com/embed/${lastVideoId}?rel=0&autoplay=1&cb=${Date.now()}`;
      setTimeout(()=>{
        ytEmbed.src = `https://www.youtube.com/embed/${lastVideoId}?rel=0&autoplay=1&cb=${Date.now()}`;
      }, 5000);
    });
  </script>
</body>
</html>
